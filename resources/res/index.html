<!DOCTYPE html>
<html>
	<head>
	<title>Sand Table</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
    <script type="text/javascript">
		var tVal, x, y, stop;
		var logoWidth = 400, logoHeight = 400;
		var logoCanvasWidth = 100, logoCanvasHeight = 100;
		var logoCentreX = logoCanvasWidth / 2, logoCentreY = logoCanvasHeight / 2;
	    var startRadius = 180;
		var overRotationFactor=1.03;
    	var segmentsPerRev = 200;
    	var modulationFreqMult = 20;
	    var endRadius = 10;
	    var outstepPerRev = -13;
	    var modulationDampingFactor = 0.6;
    	var modulationAmp = 10;

		function iconGen(canvasID)
		{
			function logoSetup() {
                tVal = 0;
                stop=false;
            }
			function logoLoop() {
				var rRadians = tVal * 2 * Math.PI * overRotationFactor / segmentsPerRev;
				var curModu = Math.sin(tVal * modulationFreqMult * 2 * Math.PI / segmentsPerRev);
				var curRadius = startRadius + outstepPerRev * tVal / segmentsPerRev;
				var radiusProp = (curRadius-Math.min(startRadius,endRadius))/Math.abs(startRadius-endRadius);
				var modDampFact = (1 - radiusProp) * modulationDampingFactor;
				var modAmpl = curRadius + curModu * modulationAmp * (1 - modDampFact);
				x = modAmpl * Math.sin(rRadians) * logoCanvasWidth / logoWidth;
				y = modAmpl * Math.cos(rRadians) * logoCanvasHeight / logoHeight;
				tVal += 1;
				stop = (curRadius > Math.max(startRadius, endRadius)) || (curRadius < Math.min(startRadius, endRadius));
			}

			var c = document.getElementById(canvasID);
			var ctx = c.getContext("2d");
			ctx.beginPath();
			ctx.lineWidth = 2;
			logoSetup();
			var ctr = 0;
			while(!stop)
			{
				logoLoop();
				if (ctr == 0)
					ctx.moveTo(logoCentreX+x, logoCentreY+y);
				else
					ctx.lineTo(logoCentreX+x, logoCentreY+y);
				if (ctr > 10000)
					break;
				ctr++;
			}
			ctx.strokeStyle = '#e0e0e0';
			ctx.stroke();

		}
		function bodyIsLoaded()
		{
		    window.stState =
				{
					curPage: ''
				};
			window.sandTableState = {
			    "maxCfgLen": 2000,
                "name": "Sand Table",
                "patterns":
                {

                },
                "sequences":
                {

                },
                "startup": ""
			};
			// Make a copy so that if the max length is exceeded we can fall back
			window.prevSandTableState = window.sandTableState;
			updateDisplay();
		}
        function callAjax(url, okCallback, failCallback)
        {
            var xmlhttp = new XMLHttpRequest();
            xmlhttp.onreadystatechange = function()
            {
                if (xmlhttp.readyState == 4) {
                    if (xmlhttp.status == 200) {
                        okCallback(xmlhttp.responseText);
                    }
                    else {
                        if ((failCallback !== undefined) && (typeof failCallback !== 'undefined'))
                            failCallback(xmlhttp);
                    }
                }
            };

            xmlhttp.open("GET", url, true);
            xmlhttp.send();
        }
        function ajaxCallback()
        {
        }
        function postJson(url, jsonStrToPos, okCallback, failCallback)
        {
            var xmlhttp = new XMLHttpRequest();
            xmlhttp.onreadystatechange = function()
            {
                if (xmlhttp.readyState == 4) {
                    if (xmlhttp.status == 200) {
                        if ((okCallback !== undefined) && (typeof okCallback !== 'undefined'))
	                        okCallback(xmlhttp.responseText);
                    }
                    else {
                        if ((failCallback !== undefined) && (typeof failCallback !== 'undefined'))
                            failCallback(xmlhttp);
                    }
                }
            };
            xmlhttp.open("POST", url);
            xmlhttp.setRequestHeader("Content-Type", "application/json");
            xmlhttp.send(jsonStrToPos);
        }
		function sandTableInfoCallback(jsonResp)
		{
			jsonData = JSON.parse(jsonResp);
			// Make a copy so that if the max length is exceeded we can fall back
			window.prevSandTableState = JSON.parse(JSON.stringify(window.sandTableState));
			window.sandTableState = jsonData;
            genPageHeader();
			genPageBody();
			iconGen("logoCanvas");
		}
		function sendSandTableInfo()
		{
		    jsonStr = JSON.stringify(window.sandTableState);
		    if (jsonStr.length > window.sandTableState.maxCfgLen)
			{
			    // Send back the previous - unchanged - state as this is too long
				alert("The robot memory is full, please simplify or remove other patterns before adding new ones")
			    jsonStr = JSON.stringify(window.prevSandTableState)
			}
            postJson("/postsettings", jsonStr, postSettingsOkCallback, postSettingsFailCallback);
		}
		function userAction(cmdStr, argStr)
		{
//		    console.log("UserAction "+ cmdStr + ", " + argStr);
		    if (cmdStr === "patDelete")
			{
			    if (confirm('Are you sure you want to delete?'))
			    {
			        // Remove from JSON
					if (argStr in window.sandTableState.patterns)
					    delete window.sandTableState.patterns[argStr];
					window.stState.curPage = "";
					sendSandTableInfo()
				}
			}
		    else if (cmdStr === "patSave") {
		        // Get values from form
				var patname = document.getElementById('patname').value.trim();
				var patsetup = document.getElementById('patsetup').value;
				var patloop = document.getElementById('patloop').value;
		        // Check name is valid
				if (patname.trim().length > 0) {
				    if ((patname === argStr.trim()) || (!(patname in window.sandTableState.patterns))) {
                        // Remove existing pattern in case name has changed
                        if (argStr in window.sandTableState.patterns)
                            delete window.sandTableState.patterns[argStr];
                        // Save new information
                        window.sandTableState.patterns[patname] = {setup: patsetup, loop: patloop};
                        window.stState.curPage = "";
                        sendSandTableInfo()
                    }
                }
            }
		    else if (cmdStr === "patCancel")
			{
				window.stState.curPage = "";
				updateDisplay();
			}
		    else if (cmdStr === "patAdd")
			{
				window.stState.curPage = "patEdit";
				window.stState.curItem = "";
				updateDisplay();
			}
			else if (cmdStr == "patEdit")
			{
			    window.stState.curPage = "patEdit";
			    window.stState.curItem = argStr;
			    updateDisplay();
			}
		}
		function postSettingsOkCallback()
		{
		    updateDisplay();
		}
		function postSettingsFailCallback()
		{
		    updateDisplay();
		}
		function genButton(clickFn, keyVal, label, cssClass)
		{
//		    console.log("Gen BUTTON url " + url + " clickFn " + clickFn + " label " + label);
			var oStr = "";
			clickFn = clickFn.replace("~key~", keyVal);
			oStr += "<span class='" + cssClass + "' onclick='" + clickFn + "'>";
			if (label == "Edit")
			{
				oStr += '<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="30px" height="30px" viewBox="0 0 530 530">';
				oStr += '<g><path d="M328.883,89.125l107.59,107.589l-272.34,272.34L56.604,361.465L328.883,89.125z M518.113,63.177l-47.981-47.981   c-18.543-18.543-48.653-18.543-67.259,0l-45.961,45.961l107.59,107.59l53.611-53.611   C532.495,100.753,532.495,77.559,518.113,63.177z M0.3,512.69c-1.958,8.812,5.998,16.708,14.811,14.565l119.891-29.069   L27.473,390.597L0.3,512.69z" style="fill: rgb(220, 222, 208);"></path></g>';
				oStr += '</svg>';
			}
//			else if (label == "Delete")
//			{
//				oStr += '<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="30px" height="30px" viewBox="0 0 414 414">';
//				oStr += '<g><path d="m 107.34348,113.4774 200.6666,201.54286 M 107.34348,315.4584 308.88635,110.84858" style="fill:none;fill-rule:evenodd;stroke:#dcded0;stroke-width:59.9;stroke-linecap:round;stroke-linejoin:miter;stroke-opacity:1;stroke-miterlimit:4;stroke-dasharray:none"/></g>';
//				oStr += '</svg>';
//			}
			else
			{
			    oStr += label;
			}
			oStr += "</span>";

//		    console.log("genButton -> " + rtnStr);
		    return oStr;
		}
		function genAjaxButton(url, key, label, cssClass)
		{
		    return genButton("callAjax(\"" + url + "\",ajaxCallback)", key, label, cssClass);
		}
		function genPageHeader()
		{
			var sandTableState = window.sandTableState;
			var headerDiv = document.getElementById("pageHeader");
			var headStr = "<div class='page-header backHead'>";
			headStr += "<div class='page-header-logo'>";
			headStr += '<canvas id="logoCanvas" class="page-logo backHead" width="' + logoCanvasWidth + '" height="' + logoCanvasHeight + '">Oops</canvas>';
			headStr += '</div>';
			headStr += "<div class='page-header-text'>";
			headStr += sandTableState.name;
			headStr += '</div>';
			headStr += '</div>';
			headerDiv.innerHTML = headStr;
		}
		function genBodyHeadingSection()
		{
			// Control section
			var oStr = "<div class='body-group backGrad1'>";
//			oStr += "<div class='body-group-header'>Control</div>";
			oStr += "<div class='body-commands'>";
			oStr += "<div class='body-commands-item'>" + genAjaxButton("/exec/pause", "", "Pause", 'body-commands-button') + "</div>";
			oStr += "<div class='body-commands-item'>" + genAjaxButton("/exec/resume", "", "Resume", 'body-commands-button') + "</div>";
			oStr += "<div class='body-commands-item'>" + genAjaxButton("/exec/restart", "", "Restart", 'body-commands-button') + "</div>";
//			oStr += "<div class='body-list-item'>" + "<a href='javascript:void(0)' onclick='postJson(\"/postsettings\", window.sandTableState)'>POST</a>" + "</div>";
			oStr += "</div>";
			oStr += "</div>";
			return oStr;
		}
		function genPatternsBody()
		{
			// Patterns section
			var listStr = "<div class='body-group backGrad2'>";
			listStr += "<div class='body-group-header'>Patterns";
			listStr += "<div class='body-group-actions'>";
			listStr += genButton("userAction(\"patAdd\",\"\")", "", "Add", 'body-group-button');
			listStr += "</div>";
			listStr += "</div>";
			listStr += "<div class='body-list'>";
			Object.keys(sandTableState.patterns).forEach(function(key,index) {
				listStr += "<div class='body-list-line'>";
          		listStr += "<div class='body-list-item'>";
				listStr += genAjaxButton("/pattern/"+key, "", key, 'body-group-button');
				listStr += "</div>";
				listStr += "<div class='body-group-actions'>";
				listStr += genButton("userAction(\"patEdit\",\"~key~\")", key, "Edit", 'body-group-button');
				listStr += "</div>";
				listStr += "</div>";
    		});
            listStr += "</div>";
            listStr += "</div>";
		    return listStr;
		}
		function genSequencesBody() {
			// Sequences section
			var listStr = "<div class='body-group backGrad3'>";
			listStr += "<div class='body-group-header'>Sequences</div>";
			listStr += "<div class='body-list'>";
			Object.keys(sandTableState.sequences).forEach(function(key,index) {
				listStr += "<div class='body-list-line'>";
          		listStr += "<div class='body-list-item'>";
				listStr += genAjaxButton("/sequence/"+key, "", key, 'body-group-button');
				listStr += "</div>";
				listStr += "<div class='body-group-actions'>";
				listStr += genButton("userAction(\"seqEdit\",\"~key~\")", key, "Edit", 'body-group-button');
				listStr += "</div>";
				listStr += "</div>";
    		});
            listStr += "</div>";
            listStr += "</div>";
            return listStr;
        }
		function genHomePageBody()
		{
			var sandTableState = window.sandTableState;
			var pageBodyDiv = document.getElementById("pageBody");

			// Body heading
			var listStr = genBodyHeadingSection();
			listStr += genPatternsBody();
			listStr += genSequencesBody();

			pageBodyDiv.innerHTML = listStr;

		}
		function genPatEditBody() {
            var sandTableState = window.sandTableState;
            var patName = window.stState.curItem;
            var patternInfo = { setup:"", loop:""};
            if (patName in window.sandTableState.patterns)
			    patternInfo = window.sandTableState.patterns[patName];
            var pageBodyDiv = document.getElementById("pageBody");

			// Body heading
			var listStr = genBodyHeadingSection();

			listStr += "<div class='body-group'>";
			listStr += "<div class='body-group-header'>Edit Pattern";
			listStr += "<div class='body-group-actions'>";
			listStr += genButton("userAction(\"patDelete\",\"~key~\")", patName, "Delete", 'body-group-button');
			listStr += "</div>";
			listStr += "<div class='body-group-actions'>";
			listStr += genButton("userAction(\"patSave\",\"~key~\")", patName, "Save", 'body-group-button');
			listStr += "</div>";
			listStr += "<div class='body-group-actions'>";
			listStr += genButton("userAction(\"patCancel\",\"~key~\")", patName, "Cancel", 'body-group-button');
			listStr += "</div>";
			listStr += "</div>";
//			listStr += genActionButtons(false, "", {"buttons":[{"toggle":false,"offStr":"Edit","actionOff":"pageNav(\"patEdit\",\"~key~\")"}]});

			listStr += "<form class='body-form'>";
			listStr += "<fieldset class='body-fieldset'>";
			listStr += "<div class='body-form-line'>";
			listStr += "<div class='body-form-label'>Name</div>";
			listStr += "<textarea id='patname' rows='1' class='body-form-field'>" + patName + "</textarea>";
            listStr += "</div>";
			listStr += "<div class='body-form-line'>";
			listStr += "<div class='body-form-label'>Setup expressions</div>";
			listStr += "<textarea id='patsetup' class='body-form-field' cols='50' rows='10'>" + patternInfo.setup + "</textarea>";
            listStr += "</div>";
			listStr += "<div class='body-form-line'>";
			listStr += "<div class='body-form-label'>Loop expressions</div>";
			listStr += "<textarea id='patloop' class='body-form-field' cols='50' rows='10'>" + patternInfo.loop + "</textarea>";
            listStr += "</div>";
            listStr += "</fieldset>";
            listStr += "</form>";
            listStr += "</div>";
			pageBodyDiv.innerHTML = listStr;
        }
		function genPageBody()
		{
		    if (window.stState.curPage.trim() == 'patEdit')
			{
				genPatEditBody();
			}
			else
			{
			    genHomePageBody();
			}
		}
		function updateDisplay()
		{
			callAjax("/getsettings", sandTableInfoCallback);
		}
    </script>
    <style>
	body {
	  font-family: Century Gothic, sans-serif;
	  line-height: 1.4em;
	  font-size: 14pt;
	  background-color:  #E3CDA6;
	  color: #c0c0c0;
		margin: 0;
	}
	.page-header{
	  padding-top: 20px;
	  padding-bottom: 20px;
	  background-color:  #E3CDA6;
	  width: 100%;
	  font-size: 1.5em;
	  color: #f0f0f0;
	  text-align: center;
	}
	.page-header-text {
		margin-top:10px;
		font-family:Copperplate, Copperplate Gothic Light, sans-serif;
	}
	.page-header-logo {

	}
	.page-logo{
		border: none;
	}
	.body-commands{
		width: 60%;
		margin-left:auto;
		margin-right:auto;
		padding-top: 20px;
		padding-bottom:20px;
	  display: flex;
	  justify-content:space-between;
	  list-style-type: none;
	}
	.body-commands-item{
	}
	.body-commands-button{
		font-size: 1.2em;
		color: #fafcee;
	}
	.body-group{
        background: -webkit-linear-gradient(top, #b9a888 0%, #c9b693 10px, #E3CDA6 100%);
	}
	.body-group-header{
		margin-left: 20px;
		padding-top: 20px;
		color: #fbf0e8;
		text-transform: uppercase;
		font-size: 1.0em;
	}
	.body-group-button {
	  color: #fafcee;
		cursor:pointer;
	}
	.body-group-button-icon {
		/*position: relative;*/
		/*left:-40px;*/
		/*top:5px;*/
		cursor:pointer;
	}
	.body-group-actions{
        margin-right: 30px;
		float: right;
	}
	.body-group-action{
	}
	.body-name{
	  padding: 10px;
	  background-color: #303030;
	  width: 100%;
	  font-size: 1.5em;
	  color: #ffffff;
	}
	.body-form {
		display: block;
	}
	.body-form-line{
		padding:5px;
	}
	.body-form-label{
		color:azure;
	}
	.body-form-field{
		width: 100%;
		background: #A89062;
		color: white;
		border:none;
	}
	.body-fieldset{
		border: none;
	}
	.body-list{
        padding: 5px;
		margin-left: auto;
		margin-right: auto;
		width: 100%;
	}
	.body-list-line{
		display:block;
		padding: 10px;
		clear: both;
	}
	.body-list-item{
		display: inline-block;
	  padding: 10px;
	  padding-left: 30px;
	  /*width: 25%;*/
	  font-size: 1.2em;
	  color: #fafcee;
	}
	.body-list-item span {
	  text-decoration: none;
	  color: #fafcee;
		cursor:pointer;
	}
	.body-list-edit span {
		color: #fafcee;
	}
	.body-list-button {
	  color: #94f3ff;
		cursor:pointer;
	}
	.body-config {
        padding: 20px;
        margin-top: 30px;
        width: 100%;
	  font-size: 1.5em;
	  color: #f0f0f0;
	}
	.body-advanced {
		padding-top: 10px;
		padding-bottom: 10px;
		margin-top: 30px;
  	  background-color: #202020;
  	  width: 100%;
  	  font-size: 1.2em;
  	  color: #000000;
  	  text-align: center;
	}
	.body-advanced a {
	  text-decoration: none;
	  color: #808080;
	}
	.body-name-edit {
		font-size: 1em;
	}
	.body-num-edit {
		font-size: 1em;
	}
	.body-name-edit {
		font-size: 1em;
	}
	.backHead {
//		background: #489080;
//		background: #4EA3D3;
		background: #407ea6;
	}
	.backGrad1 {
//		background: -webkit-linear-gradient(top, #3e91bf 0%,#459ac7 10px,#479dca 20px,#4fa8d3 30px,#4c98cf 100%);
		background: -webkit-linear-gradient(top, #4e9a8c 0%, #70ab9f 10px, #78BFC1 100%);

	}
	.backGrad2 {
//		background: -webkit-linear-gradient(top, #31659d 0%,#3869a1 10px,#396aa1 20px,#4975aa 30px,#4673a6 100%);
		background: -webkit-linear-gradient(top, #b49e73 0%, #C0A87A 10px, #C0A87A 100%);
	}
	.backGrad3 {
//		background: -webkit-linear-gradient(top, #575094 0%, #5e5296 10px, #605396 20px, #53406f 30px, #53406f 100%);
		background: -webkit-linear-gradient(top, #b9a888 0%, #c9b693 10px, #E3CDA6 100%);
	}
    </style>
</head>
<body onload="bodyIsLoaded()">

<div>
	<div id="pageHeader"></div>
	<div id="pageBody"></div>
</div>

</body>
</html>
